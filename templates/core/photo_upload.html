{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<style>
  .photo-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);  /* 2列に変更 */
    gap: 1rem;
    padding: 1rem 0;
  }
  .photo-item, .other-item {
    text-align: center;
    padding-top: 1rem;
  }
  .photo-label {
    font-weight: bold;
    margin-bottom: 0.5rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .photo-item img,
  .other-item img {
    width: 100%;
    height: auto;
    object-fit: contain;
    margin-bottom: 0.5rem;
    border-radius: 4px;
  }
  input[type="file"] {
    display: none;
  }
  .delete-btn {
    display: block;
    margin: 0.5rem auto 1rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    transition: box-shadow 0.2s;
  }
  .delete-btn:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  #add-other {
    margin-top: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    transition: box-shadow 0.2s;
  }
  #add-other:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  /* プログレス表示 */
  #upload-progress {
    display: none;
    text-align: center;
    margin-top: 1.5rem;
  }
  #upload-progress .spinner-border {
    width: 2.5rem;
    height: 2.5rem;
  }
  #upload-progress progress {
    width: 80%;
    height: 1rem;
    margin-top: 0.5rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container my-4 text-center">
  <h2 class="h3 mb-2 fw-bold">写真登録</h2>
  <div class="h6 mb-1 fw-bold">部屋番号：{{ assignment.customer.room_number }}</div>
  <div class="h6 mb-4 fw-bold">メーター番号：{{ assignment.meter_number }}</div>


  <form id="upload-form" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="photo-grid">
      {% for slot in photo_slots %}
        <div class="photo-item" data-type="{{ slot.type }}">
          <div class="photo-label">{{ slot.label }}</div>
          <input
            type="file"
            id="photo_{{ slot.type }}"
            name="photo_{{ slot.type }}"
            accept="image/*"
            capture="environment"
          >
          <label for="photo_{{ slot.type }}" style="cursor:pointer;">
            <img
              src="{% if slot.photo %}{{ slot.photo.image.url }}{% else %}{% static 'core/images/photo_icon.png' %}{% endif %}"
              alt="{{ slot.label }}"
            >
          </label>
          <button
            type="button"
            class="btn btn-danger btn-sm delete-btn"
            onclick="deletePhoto('{{ slot.type }}')"
          >削除</button>
        </div>
      {% endfor %}
    </div>

    <div id="upload-progress">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <progress id="progress-bar" max="100" value="0"></progress>
      <div class="mt-2">アップロード中…しばらくお待ちください</div>
    </div>

    <div class="text-center mb-3">
      <button
        type="button"
        id="add-other"
        class="btn btn-outline-secondary"
      >＋ その他の写真を追加</button>
    </div>

    <div class="text-center">
      <button
        type="submit"
        id="submit-btn"
        class="btn btn-primary"
      >アップロードを送信</button>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const form       = document.getElementById('upload-form');
  const submitBtn  = document.getElementById('submit-btn');
  const progressEl = document.getElementById('upload-progress');
  const progressBar= document.getElementById('progress-bar');
  const csrfToken  = document.querySelector('input[name=csrfmiddlewaretoken]').value;

  form.addEventListener('submit', e => {
    e.preventDefault();
    submitBtn.disabled = true;
    submitBtn.innerText = '送信中…';
    progressEl.style.display = 'block';

    const fd = new FormData(form);
    const xhr = new XMLHttpRequest();
    xhr.open('POST', form.action, true);
    xhr.setRequestHeader('X-CSRFToken', csrfToken);

    xhr.upload.addEventListener('progress', ev => {
      if (ev.lengthComputable) {
        progressBar.value = Math.round(ev.loaded / ev.total * 100);
      }
    });

    xhr.onload = () => {
      if (xhr.status >= 200 && xhr.status < 300) {
        window.location.href = xhr.responseURL || window.location.href;
      } else {
        alert('アップロードに失敗しました。');
        submitBtn.disabled = false;
        submitBtn.innerText = 'アップロードを送信';
        progressEl.style.display = 'none';
      }
    };

    xhr.onerror = () => {
      alert('通信エラーが発生しました。');
      submitBtn.disabled = false;
      submitBtn.innerText = 'アップロードを送信';
      progressEl.style.display = 'none';
    };

    xhr.send(fd);
  });

  window.deletePhoto = type => {
    const delForm = document.createElement('form');
    delForm.method = 'post';
    delForm.style.display = 'none';
    delForm.innerHTML = `
      <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
      <input type="hidden" name="delete_photo" value="${type}">
    `;
    document.body.appendChild(delForm);
    delForm.submit();
  };

  function initItem(el) {
    const input = el.querySelector('input[type="file"]');
    const img   = el.querySelector('img');
    el.querySelector('label').addEventListener('click', () => input.click());
    input.addEventListener('change', () => {
      const file = input.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = e => img.src = e.target.result;
      reader.readAsDataURL(file);
    });
  }

  document.querySelectorAll('.photo-item').forEach(initItem);

  document.getElementById('add-other').addEventListener('click', () => {
    const tpl = document.createElement('div');
    tpl.className = 'other-item';
    tpl.innerHTML = `
      <div class="photo-label">その他</div>
      <input type="file" name="other_photos" accept="image/*" capture="environment">
      <label style="cursor:pointer;"><img src="{% static 'core/images/photo_icon.png' %}"></label>
      <input type="text" name="other_titles" class="form-control mt-2" placeholder="タイトル">
      <button type="button" class="btn btn-danger btn-sm delete-btn">削除</button>
    `;
    document.querySelector('.photo-grid').appendChild(tpl);
    initItem(tpl);
    tpl.querySelector('.delete-btn').addEventListener('click', () => tpl.remove());
  });
});
</script>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const form        = document.getElementById('upload-form');
  const submitBtn   = document.getElementById('submit-btn');
  const progressEl  = document.getElementById('upload-progress');
  const progressBar = document.getElementById('progress-bar');
  const csrfToken   = document.querySelector('input[name=csrfmiddlewaretoken]').value;

  // XHR送信はそのまま
  form.addEventListener('submit', e => {
    e.preventDefault();
    submitBtn.disabled = true;
    submitBtn.innerText = '送信中…';
    progressEl.style.display = 'block';

    const fd  = new FormData(form);
    const xhr = new XMLHttpRequest();
    xhr.open('POST', form.action, true);
    xhr.setRequestHeader('X-CSRFToken', csrfToken);

    xhr.upload.addEventListener('progress', ev => {
      if (ev.lengthComputable) {
        progressBar.value = Math.round(ev.loaded / ev.total * 100);
      }
    });
    xhr.onload  = () => {
      if (xhr.status >= 200 && xhr.status < 300) {
        window.location.href = xhr.responseURL || window.location.href;
      } else {
        alert('アップロードに失敗しました。');
        submitBtn.disabled = false;
        submitBtn.innerText = 'アップロードを送信';
        progressEl.style.display = 'none';
      }
    };
    xhr.onerror = () => {
      alert('通信エラーが発生しました。');
      submitBtn.disabled = false;
      submitBtn.innerText = 'アップロードを送信';
      progressEl.style.display = 'none';
    };
    xhr.send(fd);
  });

  // 削除フォームもそのまま
  window.deletePhoto = type => {
    const delForm = document.createElement('form');
    delForm.method = 'post';
    delForm.style.display = 'none';
    delForm.innerHTML = `
      <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
      <input type="hidden" name="delete_photo" value="${type}">
    `;
    document.body.appendChild(delForm);
    delForm.submit();
  };

  // ファイル選択後すぐに送信する initItem
  function initItem(el) {
    const input = el.querySelector('input[type="file"]');
    const img   = el.querySelector('img');
    const label = el.querySelector('label');

    label.addEventListener('click', () => input.click());

    input.addEventListener('change', () => {
      const file = input.files[0];
      if (!file) return;

      // プレビュー
      const url = URL.createObjectURL(file);
      img.src = url;

      // 撮影後すぐに送信
      if (typeof form.requestSubmit === 'function') {
        form.requestSubmit();
      } else {
        form.dispatchEvent(new Event('submit', {cancelable: true, bubbles: true}));
      }
    });
  }

  document.querySelectorAll('.photo-item').forEach(initItem);

  document.getElementById('add-other').addEventListener('click', () => {
    const tpl = document.createElement('div');
    tpl.className = 'other-item';
    tpl.innerHTML = `
      <div class="photo-label">その他</div>
      <input type="file" name="other_photos" accept="image/*" capture="environment">
      <label style="cursor:pointer;"><img src="{% static 'core/images/photo_icon.png' %}"></label>
      <input type="text" name="other_titles" class="form-control mt-2" placeholder="タイトル">
      <button type="button" class="btn btn-danger btn-sm delete-btn">削除</button>
    `;
    document.querySelector('.photo-grid').appendChild(tpl);
    initItem(tpl);
    tpl.querySelector('.delete-btn').addEventListener('click', () => tpl.remove());
  });
});
</script>
{% endblock %}
